#!/usr/local/bin/perl

# See http://www.netzmafia.de/skripten/unix/linux-daemon-howto.html
# and http://www.perlmonks.org/?node_id=374409

use boolean;
use Config::Any;
use Getopt::Long;
use M3MTA::Server::IMAP;
use M3MTA::Daemon;
use Modern::Perl;

my ($stop, $daemon, $config, $pidfile, $logfile);
GetOptions(
    'stop' => \$stop,
    'daemon' => \$daemon,
    'config=s' => \$config,
    'pidfile=s' => \$pidfile,
    'logfile=s' => \$logfile,
);

my $imap_daemon = M3MTA::Daemon->new(
    name => 'M3MTA-IMAP',
    pidfile => $pidfile,
    stdout => $logfile ? "$logfile.out" : undef,
    stderr => $logfile ? "$logfile.err" : undef,
);

exit $imap_daemon->stop if $stop;

$imap_daemon->start(
    begin => sub {
        print "Starting IMAP daemon\n";
        $config ||= 'config.json';
        my $cfg = Config::Any->load_files({ files => [$config], use_ext => 1 })->[0]->{$config}->{imap};
        M3MTA::Server::IMAP->new(config => $cfg)->start;
    }
);